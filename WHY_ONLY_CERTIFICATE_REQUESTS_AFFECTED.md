# Why Only Certificate Requests Show the Timezone Bug

## TL;DR
**Events use user-entered DATE/TIME** (manually set by organizers in Manila timezone)  
**Certificate requests use auto-generated DATETIME** (set by MySQL server in CET timezone)

This difference means events were already correct, but certificate requests were misinterpreted.

---

## The Key Difference

### Events (`created_events` table)
```sql
CREATE TABLE `created_events` (
  ...
  `start_date` date DEFAULT NULL,        -- User enters: "2025-12-01"
  `start_time` time DEFAULT NULL,        -- User enters: "13:46:00"
  `end_date` date DEFAULT NULL,
  `end_time` time DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),  -- TIMESTAMP (auto-converts)
  ...
)
```

**How events work:**
1. **Organizer creates event** in Manila (Philippines)
   - Frontend: User picks date "Dec 1, 2025" and time "13:46"
   - Backend stores: `start_date='2025-12-01'`, `start_time='13:46:00'`

2. **These are NOT timestamps** - they're separate DATE and TIME fields
   - The organizer **intends** these to be Manila time
   - The values are **explicitly entered by users**, not auto-generated

3. **Backend correctly interprets them as Manila time:**
   ```javascript
   // eventController.js line 124
   const sd = ev.start_date 
     ? parseMysqlLocalStringToDate(`${ev.start_date} ${ev.start_time || '00:00:00'}`, EVENT_TZ_OFFSET) 
     : null;
   // Uses EVENT_TZ_OFFSET (+08:00) because the organizer entered Manila time
   ```

4. **This is correct** because:
   - The organizer is in Manila
   - They enter "13:46" meaning "13:46 Manila time"
   - Using `EVENT_TZ_OFFSET=+08:00` correctly interprets their intent

### Certificate Requests (`certificate_requests` table)
```sql
CREATE TABLE `certificate_requests` (
  ...
  `requested_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP(),  -- Auto-generated!
  `processed_at` datetime DEFAULT NULL,
  ...
)
```

**How certificate requests work (BEFORE the fix):**
1. **Student clicks "Request Certificate"** at 13:46 Manila time
   - Current time in Manila: 13:46 (UTC+8)
   - Current time on AlwaysData server (CET): 06:46 (UTC+1)

2. **MySQL auto-generates the timestamp** using `CURRENT_TIMESTAMP()`
   - MySQL server timezone: CET (UTC+1)
   - Stores in DB: `'2025-12-01 06:46:00'` (the server's local time)

3. **Backend INCORRECTLY interpreted this as Manila time** (before fix):
   ```javascript
   // BEFORE FIX (certificateRequestModel.js)
   const EVENT_TZ_OFFSET = '+08:00';
   const d = parseMysqlLocalStringToDate(out.requested_at, EVENT_TZ_OFFSET);
   // ‚ùå WRONG! Interprets '06:46:00' as Manila time
   // Converts: 06:46 - 08:00 = 22:46 previous day UTC
   ```

4. **Why this was wrong:**
   - The value `'06:46:00'` was NOT entered by a Manila user
   - It was auto-generated by the CET MySQL server
   - Should use `SERVER_TZ_OFFSET=+01:00` not `EVENT_TZ_OFFSET=+08:00`

---

## Side-by-Side Comparison

| Aspect | Events | Certificate Requests |
|--------|--------|---------------------|
| **Data Source** | User-entered dates/times | MySQL auto-generated |
| **Timezone Intent** | User's timezone (Manila) | Server's timezone (CET) |
| **Storage** | Separate DATE + TIME columns | Single DATETIME column |
| **MySQL Function** | None (manual entry) | `CURRENT_TIMESTAMP()` |
| **Correct Offset** | `EVENT_TZ_OFFSET` (+08:00) | `SERVER_TZ_OFFSET` (+01:00) |
| **Was it buggy?** | ‚úÖ No - already correct | ‚ùå Yes - before our fix |

---

## Other Models That Use `CURRENT_TIMESTAMP()`

### Notifications (`notifications` table)
```sql
created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
```

**Status:** ‚úÖ **Already fixed before this issue**
- Uses `SERVER_TZ_OFFSET` (line 3 of notificationModel.js)
- Correctly interprets DATETIME as server timezone

### Organization Members (`organizationmembers` table)
```sql
joined_at timestamp NOT NULL DEFAULT current_timestamp(),
```

**Status:** ‚úÖ **No bug here**
- Uses `TIMESTAMP` not `DATETIME`
- `TIMESTAMP` automatically stores as UTC and converts based on session timezone
- MySQL handles conversion automatically

---

## Why `TIMESTAMP` vs `DATETIME` Matters

### TIMESTAMP (auto-handles timezone)
```sql
joined_at timestamp NOT NULL DEFAULT current_timestamp()
```
- Stored internally as **UTC** (seconds since Unix epoch)
- Automatically converted to session timezone on retrieval
- MySQL handles timezone conversion
- **No manual parsing needed** ‚úÖ

### DATETIME (no timezone awareness)
```sql
requested_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP()
```
- Stored as **literal string** in server's local timezone
- NO automatic conversion
- Application must **manually interpret** what timezone it represents
- **Requires correct parsing** with `SERVER_TZ_OFFSET` ‚ö†Ô∏è

---

## Summary

### Why ONLY certificate requests were affected:

1. **Events:** User-entered dates in Manila time ‚Üí correctly use `EVENT_TZ_OFFSET` ‚úÖ
2. **Notifications:** Auto-generated but already use `SERVER_TZ_OFFSET` ‚úÖ
3. **Organization members:** Use `TIMESTAMP` which auto-converts ‚úÖ
4. **Certificate requests:** Auto-generated DATETIME but wrongly used `EVENT_TZ_OFFSET` ‚ùå

### The Fix

Changed `certificateRequestModel.js` to:
```javascript
// BEFORE (wrong)
const EVENT_TZ_OFFSET = process.env.EVENT_TZ_OFFSET || '+08:00';
parseMysqlLocalStringToDate(requested_at, EVENT_TZ_OFFSET);

// AFTER (correct)
const SERVER_TZ_OFFSET = process.env.SERVER_TZ_OFFSET || '+08:00';
const EVENT_TZ_OFFSET = process.env.EVENT_TZ_OFFSET || '+08:00';
parseMysqlLocalStringToDate(requested_at, SERVER_TZ_OFFSET); // Parse as server TZ
formatDateToOffsetStrings(date, EVENT_TZ_OFFSET);            // Display in event TZ
```

### Lesson Learned

When using `CURRENT_TIMESTAMP()` with DATETIME columns:
- ‚úÖ **DO:** Use the MySQL server's timezone offset for parsing
- ‚ùå **DON'T:** Assume the DATETIME represents the user's timezone
- üí° **BETTER:** Use `TIMESTAMP` type for auto-generated timestamps (it handles timezone automatically)

---

## Date: December 1, 2025
